#!/bin/sh
# Pre-commit hook for tmuxrs
set -eu

echo "Running pre-commit checks..."

# Stash unstaged changes to preserve developer's work
stash_name="pre-commit-stash-$$"
git stash push -k -u -m "$stash_name" >/dev/null || true

# Cleanup function to restore stash on any exit
cleanup_stash() {
    if git stash list | grep -q "$stash_name"; then
        git stash pop --quiet >/dev/null || true
    fi
}

# Set up EXIT trap to ensure stash is always restored
trap cleanup_stash EXIT

# Check formatting and auto-fix if needed
echo "Checking code formatting..."
if ! cargo fmt -- --check
then
    echo "Auto-fixing code formatting..."
    cargo fmt
    git add -u  # Stage formatting fixes
    echo "✅ Code formatting fixed and staged"
fi

# Run clippy
echo "Running clippy..."
if ! cargo clippy --all-targets -- -D warnings
then
    echo "❌ Clippy warnings detected!"
    echo "Fix the clippy warnings before committing."
    exit 1
fi

# Run tests
echo "Running tests..."
if ! cargo test
then
    echo "❌ Tests failed!"
    echo "Fix failing tests before committing."
    exit 1
fi

echo "✅ All pre-commit checks passed!"